name: Sync Release to Gitee

on:
  release:
    types: [published]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync release and assets to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          GITEE_OWNER="daizf00"
          GITEE_REPO="kraph"
          TAG="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_ID="${{ github.event.release.id }}"
          GH_REPO="${{ github.repository }}"

          # 1. 创建 Gitee Release
          echo "Creating Gitee release for tag: $TAG"

          BODY=$(cat <<'BODY_EOF'
          ${{ github.event.release.body }}
          BODY_EOF
          )

          RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/$GITEE_OWNER/$GITEE_REPO/releases" \
            -H "Content-Type: application/json" \
            -d "{
              \"access_token\": \"$GITEE_TOKEN\",
              \"tag_name\": \"$TAG\",
              \"name\": \"$RELEASE_NAME\",
              \"target_commitish\": \"master\",
              \"prerelease\": false
            }")

          echo "Gitee response: $RESPONSE"
          GITEE_RELEASE_ID=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('id',''))")

          if [ -z "$GITEE_RELEASE_ID" ]; then
            echo "Failed to create Gitee release."
            exit 1
          fi
          echo "Gitee Release ID: $GITEE_RELEASE_ID"

          # 2. 获取 GitHub Release 附件列表
          ASSETS_JSON=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$GH_REPO/releases/$RELEASE_ID/assets")

          ASSET_COUNT=$(echo "$ASSETS_JSON" | python3 -c "import sys,json; print(len(json.load(sys.stdin)))")
          echo "Found $ASSET_COUNT assets to upload"

          if [ "$ASSET_COUNT" -eq 0 ]; then
            echo "No assets found, skipping upload."
            echo "Done! Gitee release: https://gitee.com/$GITEE_OWNER/$GITEE_REPO/releases/tag/$TAG"
            exit 0
          fi

          # 3. 下载并逐一上传附件到 Gitee
          echo "$ASSETS_JSON" | python3 - <<PYEOF
          import sys, json, subprocess, urllib.request

          assets = json.load(sys.stdin)
          gitee_token = "$GITEE_TOKEN"
          gitee_owner = "$GITEE_OWNER"
          gitee_repo = "$GITEE_REPO"
          gitee_release_id = "$GITEE_RELEASE_ID"

          for asset in assets:
              name = asset['name']
              url = asset['browser_download_url']
              print(f'Downloading {name} ...')
              urllib.request.urlretrieve(url, name)
              print(f'Uploading {name} to Gitee ...')
              result = subprocess.run([
                  'curl', '-s', '-X', 'POST',
                  f'https://gitee.com/api/v5/repos/{gitee_owner}/{gitee_repo}/releases/{gitee_release_id}/attach_files',
                  '-F', f'access_token={gitee_token}',
                  '-F', f'file=@{name}'
              ], capture_output=True, text=True)
              if result.returncode != 0:
                  print(f'Error: {result.stderr}')
              else:
                  print(f'Done: {name}')
          PYEOF

          echo "All done! https://gitee.com/$GITEE_OWNER/$GITEE_REPO/releases/tag/$TAG"
