# 知识融合功能说明

## 概述

已成功实现**方案三：知识融合与增量更新**，这是最强大的知识图谱关联方案。现在系统能够：

1. ✅ **智能识别实体别名**：自动识别"李明"和"我二哥"是同一个人
2. ✅ **关系传递推理**：从"李明是我二哥"+"我二哥在字节上班" 推导出"李明在字节上班"
3. ✅ **增量知识更新**：每次保存记忆时，自动结合历史记忆进行全局推理

## 核心改进

### 1. 数据库层面
- **新增表**: `entity_aliases` - 存储实体别名关系
- **新增函数**:
  - `add_entity_alias()` - 添加实体别名
  - `find_entity_id_by_name_or_alias()` - 通过名称或别名查找实体
  - `merge_entities()` - 合并重复实体
  - `get_entity_aliases()` - 获取实体的所有别名

### 2. AI推理层面
- **知识融合Prompt**: 专门设计的prompt让LLM进行：
  - 实体合并识别（识别同一实体的不同称呼）
  - 关系传递推导（从关系链推导隐含关系）
  - 完整知识提取（输出实体、别名、关系的完整图谱）

- **新增函数**: `call_ollama_knowledge_fusion()` - 调用LLM进行知识融合

### 3. 保存逻辑
保存记忆时的处理流程：

```
1. 快速提取 → 获取实体名称
   ↓
2. 查询历史 → 获取相关实体的历史记忆（最多5条/实体）
   ↓
3. 知识融合 → 将历史+新记忆一起送给LLM推理
   ↓
4. 实体处理 → 创建实体、处理别名、合并重复实体
   ↓
5. 关系建立 → 建立所有关系（包括推导的关系）
```

## 使用示例

### 场景：李明的多重身份识别

**输入序列**：
```
1. "李明是我的同事"
   → 提取：[Person: 李明, Person: 我]
   → 关系：[李明 → 我: 同事]

2. "李明是我二哥"
   → 知识融合分析历史："李明是我的同事" + 新输入
   → 识别：李明 = 我二哥（别名关系）
   → 建立别名：李明 <-> 我二哥

3. "我二哥在字节上班"
   → 知识融合分析历史："李明是我的同事" + "李明是我二哥" + 新输入
   → 推导：我二哥 = 李明 → 李明在字节上班
   → 建立关系：[李明 → 字节: 在...上班]
```

**结果**：
- 实体：李明（别名：我二哥）、我、字节
- 关系：
  - 李明 → 我：同事
  - 李明 → 字节：在...上班

### 查询效果

现在查询"李明在哪里工作？"能够正确返回"字节"，因为：
1. 系统识别出"李明"="我二哥"
2. 从"我二哥在字节上班"推导出"李明在字节上班"

## 关键优势

### 相比方案一（别名表）
- ✅ 不需要手动规则，LLM自动识别
- ✅ 能处理复杂的同义关系（不仅是"是"关系）

### 相比方案二（查询时推理）
- ✅ 推理结果持久化，不用每次查询都计算
- ✅ 知识图谱更完整，可直接展示推导关系

### 智能特性
1. **上下文感知**：结合历史记忆理解新输入
2. **关系传递**：自动推导间接关系
3. **实体归一**：识别并合并同一实体的不同称呼
4. **容错性好**：如果知识融合失败，自动回退到简单提取

## 性能优化

- 历史记忆限制：每个实体最多取5条相关记忆（避免prompt过长）
- 两阶段处理：先快速提取找相关实体，再深度融合推理
- 自动去重：避免重复记忆进入融合分析

## 模型要求

- **快速提取**：`qwen2.5:1.5b`（轻量级，用于初步提取）
- **知识融合**：`qwen2.5:7b`（更强推理能力，用于深度分析）

## 后续扩展方向

1. **冲突检测**：识别矛盾的关系（如"A是B的老板" vs "A是B的下属"）
2. **置信度评分**：为推导关系添加置信度
3. **可视化增强**：在图谱中区分直接关系和推导关系
4. **用户确认**：对不确定的实体合并请求用户确认

## 测试建议

建议按以下顺序测试：

1. 添加记忆："李明是我的同事"
2. 添加记忆："李明是我二哥" 
3. 添加记忆："我二哥在字节上班"
4. 查看知识图谱，确认"李明"有"在字节上班"的关系
5. 搜索"李明"，查看所有相关信息

## 文件变更清单

- ✅ `src-tauri/src/database.rs` - 添加别名表和函数
- ✅ `src-tauri/src/ollama.rs` - 添加知识融合推理
- ✅ `src-tauri/src/lib.rs` - 修改保存和更新逻辑

## 注意事项

1. **首次运行**：会自动创建`entity_aliases`表（数据库会自动迁移）
2. **模型依赖**：需要确保Ollama已安装并拉取了`qwen2.5:7b`模型
3. **性能考虑**：知识融合会调用较大模型，处理时间可能需要3-5秒

---

创建时间：2026-02-15
作者：AI Assistant
