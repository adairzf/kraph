# 编辑功能增强 - 自动更新图谱

## 🔧 问题
之前编辑记忆时，只是更新了文本内容，但没有重新提取实体，导致图谱中的节点和关系不会更新。

## ✅ 解决方案
现在编辑记忆时会自动：

1. **重新提取实体**
   - 使用 Ollama AI 模型重新分析修改后的内容
   - 识别新的人物、地点、时间、事件等实体

2. **清除旧关联**
   - 删除该记忆的所有旧实体关联

3. **建立新关联**
   - 将新提取的实体与记忆关联
   - 建立实体之间的新关系

4. **清理孤立节点**
   - 删除不再关联任何记忆的孤立实体
   - 删除涉及已删除实体的关系

5. **自动刷新图谱**
   - 前端自动调用 `fetchGraph()` 更新显示

## 📝 修改的文件

### 后端 (Rust)
1. **src-tauri/src/database.rs**
   - 添加 `clear_memory_entities()`: 清除指定记忆的所有实体关联

2. **src-tauri/src/lib.rs**
   - 重写 `update_memory_content()`: 
     - 调用 Ollama 重新提取实体
     - 清除旧关联
     - 建立新关联
     - 清理孤立实体和关系

## 🚀 使用示例

### 场景：修改记忆中的人名

**原始记忆内容：**
```
今天和张三一起吃饭，讨论了项目进展。
```
**图谱显示：** 节点【张三】

**修改后的内容：**
```
今天和李四一起吃饭，讨论了项目进展。
```
**图谱更新：** 
- 节点【张三】被删除（如果没有其他记忆提到）
- 新增节点【李四】

### 场景：添加新实体

**原始记忆：**
```
去了一家餐厅
```
**图谱：** 无节点

**修改后：**
```
去了北京的王府井餐厅，和小明见面
```
**图谱：**
- 新增【北京】（地点）
- 新增【王府井餐厅】（地点）
- 新增【小明】（人物）
- 建立它们之间的关系

## ⚙️ 技术实现

### 实体提取流程
```
用户编辑内容
    ↓
调用 Ollama AI 模型
    ↓
提取实体列表 {人物, 地点, 时间, 事件}
    ↓
清除该记忆的旧实体关联
    ↓
建立新实体关联
    ↓
清理孤立实体
    ↓
返回更新后的记忆
    ↓
前端自动刷新图谱
```

### 使用的 Ollama 模型
- **优先使用**: `qwen2.5:1.5b` (轻量级，速度快)
- **备用模型**: `qwen2.5:7b` (更准确)

## 📊 性能考虑

1. **AI 模型调用**
   - 只在保存时调用一次
   - 异步处理，不阻塞 UI
   - 如果内容少于 5 个字符，跳过实体提取

2. **数据库优化**
   - 使用事务确保数据一致性
   - 批量删除孤立实体
   - 索引优化查询性能

3. **前端体验**
   - 保存时显示"保存中…"状态
   - 完成后显示成功提示
   - 自动刷新图谱

## 🐛 注意事项

1. **需要 Ollama 运行**
   - 编辑功能需要 Ollama 服务运行
   - 如果 Ollama 未运行或模型未下载，会提示错误
   - 但内容仍会保存，只是不会提取实体

2. **短内容处理**
   - 内容少于 5 个字符不会提取实体
   - 避免无意义的 AI 调用

3. **实体清理**
   - 编辑可能导致某些实体被删除
   - 只有完全不被任何记忆引用的实体才会被清理
   - 这是预期行为，保持图谱整洁

## 🔄 更新步骤

1. **重新编译应用**
   ```bash
   npm run tauri dev
   ```

2. **测试编辑功能**
   - 选择一条记忆
   - 修改内容（改变人名、地点等）
   - 点击"保存"
   - 观察图谱自动更新

3. **确认效果**
   - 旧实体消失（如果没有其他引用）
   - 新实体出现
   - 关系正确建立

## 💡 最佳实践

1. **清晰的实体表达**
   - 明确写出人名、地点等信息
   - 使用完整的名称而不是代词
   - 例如："和小明见面" 优于 "和他见面"

2. **结构化内容**
   - 使用自然语言描述事件
   - 包含时间、地点、人物、事件等要素
   - 例如："2024年1月1日在北京和小明讨论项目"

3. **避免频繁小改动**
   - 每次保存都会重新提取实体
   - 建议完成编辑后再保存
   - 减少不必要的 AI 调用
